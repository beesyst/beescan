<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SecWebScan Report</title>
    {% if report_theme == "dark" %}
    <link rel="stylesheet" href="../templates/css/style_dark.css">
    {% else %}
    <link rel="stylesheet" href="../templates/css/style_light.css">
    {% endif %}
</head>

<body>
    <h1>SecWebScan Report</h1>

    {% set scan_target = config["scan_config"].get("target_domain", "") %}
    {% set resolved_ip = config["scan_config"].get("target_ip", "") %}

    <div class="module">
        {% if resolved_ip %}
        <p><strong>IP:</strong> {{ resolved_ip }}</p>
        {% endif %}
        {% if scan_target %}
        <p><strong>Domain:</strong> {{ scan_target }}</p>
        {% endif %}
        <p><strong>Time:</strong> {{ meta.created_at or "Unknown" }}</p>
    </div>

    {% for category, modules in structured_results.items() %}
    <div class="module">
        <h2>{{ category }}</h2>

        {% for module_name, entries in modules.items() %}
        <h3>{{ module_name }}</h3>

        {% set exclude_keys = ["source", "severity", "created_at", "module"] %}
        {% if entries and entries[0]["data"] is iterable and entries[0]["data"] is not string and entries[0]["data"][0]
        is mapping %}
        {% set all_keys = entries[0]["data"][0].keys() | reject("in", exclude_keys) | list %}
        {% else %}
        {% set all_keys = [] %}
        {% endif %}

        {% set column_order = namespace(keys=all_keys) %}
        {% if module_name == "nmap" %}
        {% set column_order.keys = ["cpe", "port", "extra", "state", "reason", "product", "version", "protocol",
        "service_name", "script_output"] | select("in", all_keys) | list %}
        {% elif module_name == "nikto" %}
        {% set column_order.keys = ["id", "msg", "url", "method"] | select("in", all_keys) | list %}
        {% elif module_name == "dig" %}
        {% set column_order.keys = ["ttl", "data", "name", "type", "target", "section"] | select("in", all_keys) | list
        %}
        {% endif %}

        {% if column_order.keys %}
        <table>
            <thead>
                <tr>
                    {% for key in column_order.keys %}
                    <th>{{ key.replace('_', ' ') | title }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in entries[0]["data"] %}
                <tr>
                    {% for key in column_order.keys %}
                    <td>{{ row[key] if row[key] else "-" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <pre>{{ entries[0]["data"] | tojson(indent=2) }}</pre>
        {% endif %}
        {% endfor %}
    </div>
    {% endfor %}

    <div class="footer">
        Generated by SecWebScan | {{ generation_time }}
    </div>
</body>

</html>